---
 title: "Assignment 2"
subtitle: "Text as Data"
date: "2022-10-13"
author: "Janine De Vera | 219848"
output: 
 pdf_document:
 keep_tex: true
citation_package: natbib
header-includes:
 - \usepackage{booktabs}
- \usepackage{xcolor}
extra_dependencies: ["hyperref","booktabs"]
urlcolor: blue
bibliography: ../presentation-resources/MyLibrary.bib
---
 
```{r setup, include = FALSE}
knitr::opts_chunk$set(echo = FALSE, 
                      warning = FALSE, 
                      error = FALSE, 
                      message = FALSE)
```

```{r, include = FALSE}
pacman::p_load(tidyverse, readr, stringr, quanteda, quanteda.textstats, rvest, 
               tibble, xml2, manifestoR, topicmodels, tidytext, stm)
```

```{r, include = FALSE}
charts.theme <- theme(axis.title.y.left = element_text(size = 12, margin = margin(r = 15)),
                      axis.title.y.right = element_text(size = 12, margin = margin(l = 15)),
                      axis.title.x = element_text(size = 12, margin = margin(t = 15)),
                      axis.text.x = element_text(size = 12),
                      axis.text.y = element_text(size = 12),
                      axis.ticks = element_blank(),
                      axis.line.x = element_line("transparent", size = 0.5), 
                      axis.line.y = element_line("transparent", size = 0.5),
                      panel.border = element_rect(color = "#a3a3a3", fill = "transparent"),
                      panel.background = element_rect(fill = "white", color = "white"),
                      panel.grid.major = element_line(color = "#d4d4d4", linetype = 2),
                      plot.title = element_text(size = 12, face = "bold", hjust = 0.5),
                      plot.subtitle = element_text(size = 10, face = "italic", hjust = 0.5, margin = margin(b = 15)),
                      plot.caption = element_text(size = 10, hjust = 0),
                      strip.background = element_rect(fill = "transparent"),
                      strip.text = element_text(size = 12),
                      legend.key=element_blank())
```


 # Introduction
 
 In this assignment, you are asked to use topic modelling to investigate manifestos from the manifesto project maintained by [WZB](https://manifesto-project.wzb.eu/). You can either use the UK manifestos we looked at together in class, or collect your own set of manifestos by choosing the country/countries, year/years and party/parties you are interested in. You should produce a report which includes your code, that addresses the following aspects of creating a topic model, making sure to answer the questions below.

## 1. Data acquisition, description, and preparation
#### Manifesto data from WZB database
```{r}
mp_setapikey("manifesto_apikey.txt")
```

Create a dataset of the party manifestos from the United States and United Kingdom from 1960 until the present. 
```{r}
# define countries of interest
countries <- c('United States', 'United Kingdom')

# create list of corpus from US and UK starting 1960
corpus_list <- list()
for (i in countries) {
 x <- mp_corpus(countryname == i  & edate > as.Date("1960-01-01"))
 corpus_list[[i]] <- x
}

# extract manifestos per country and combine to a dataframe
df_list <- list()
country_list <- list()
for (j in 1:length(corpus_list)) {
 doc <-  corpus_list[[j]]
 for (k in 1:length(doc)){
  temp <- doc[[k]]
  df <- temp %>% as.data.frame() %>% 
   select(text) %>% mutate(source = names(doc[k]))
  df_list[[k]] <- df
  country_df <- do.call(rbind.data.frame, df_list) %>% 
   na_if("") %>% na.omit %>% 
   mutate(country = names(corpus_list[j])) 
 }
 country_list[[j]] <- country_df
 full_df <- do.call(rbind.data.frame, country_list)
}
```

```{r}
# separate sentences, extract manifestos per country, and combine to a dataframe
df_list <- list()
country_list <- list()
for (j in 1:length(corpus_list)) {
 doc <-  corpus_list[[j]]
 for (k in 1:length(doc)){
  temp <- doc[[k]]
  df <- if (length(temp) == 1) temp %>% str_split(., "[.]") %>% unlist() %>% as.data.frame() %>% rename(., text = .)
        else temp %>% as.data.frame() %>% select(text)
  df <- df %>% mutate(source = names(doc[k]))
  df_list[[k]] <- df
  country_df <- do.call(rbind.data.frame, df_list) %>% 
   na_if("") %>% na.omit %>% 
   mutate(country = names(corpus_list[j]))
 }
 country_list[[j]] <- country_df
 full_df <- do.call(rbind.data.frame, country_list)
}
```

```{r}
# get meta dataset and create id to match with corpus df 
corpus_dict <- main %>% 
 mutate(corpus_code = paste0(party, "_", date)) %>% 
 select(corpus_code, edate, partyname, partyabbrev)

# join dfs to match party, date, country
corpus_df <- inner_join(corpus_dict, full_df, by = c("corpus_code" = "source"))

# filter df 
foreign_df <- corpus_df %>% 
  filter(str_detect(text, 'Foreign|foreign|foreign policy|Foreign Policy|FOREIGN POLICY|FOREIGN'))
```

```{r}
# create document feature matrix
dfmat <- foreign_df %>%
 select(text) %>% 
 unlist() %>% 
 tokens(remove_punc = TRUE) %>% 
 tokens_remove(pattern=stopwords("en")) %>% 
 tokens_replace(pattern = lexicon::hash_lemmas$token, replacement = lexicon::hash_lemmas$lemma) %>%
 dfm() #%>% 
 #dfm_tfidf()
dfmat

rownames(dfmat) <- foreign_df$corpus_code

```


```{r}
topfeatures(dfmat, n = 30, scheme = "docfreq")
```

```{r}
lda <- LDA(dfmat,  4)
```

```{r}
# document-topic probability
topics <- tidy(lda, matrix = "gamma") %>% 
 mutate(document_id = str_remove(document, "\\.[1-9]*$")) %>% 
 left_join(., foreign_df %>% select(!text), by = c("document_id" = "corpus_code"))
 
topic_df <- topics %>%
 mutate(year = lubridate::year(edate)) %>% 
 mutate(period = ifelse(year < 1991, "Cold War", "Post-Cold War")) %>% 
 na.omit

# check how many documents there are per period
topic_df %>% 
   group_by(period) %>%
   summarise(counts = n())
```

```{r}
# share of topics per time period
share_period <- topic_df %>% 
 group_by(period, topic) %>% 
 summarise(gamma = sum(gamma)) %>% 
 group_by(period) %>% 
 mutate(year_share = gamma/sum(gamma)) %>% 
 ungroup() %>% 
 mutate(topic = factor(topic))

# share of topics per time period
share_period_country <- topic_df %>% 
 group_by(period, topic, country) %>% 
 summarise(gamma = sum(gamma)) %>% 
 group_by(period, country) %>% 
 mutate(year_share = gamma/sum(gamma)) %>% 
 ungroup() %>% 
 mutate(topic = factor(topic))
```


This plot shows us 
```{r}
plot1_df <- share_period %>% 
 group_by(period) %>% 
 mutate(alpha = ifelse(max(year_share) == year_share, "yes", "no"),
        year_share = ifelse(period == "Cold War", -1*year_share, year_share))


plot1 <-  ggplot(plot1_df, aes(x=fct_rev(topic), y=year_share*100, label=period)) + 
  geom_hline(yintercept = 0, size = 0.4, linetype = 2) +
  geom_point(stat='identity', fill="black", size=6, aes(color = period, alpha = alpha))  +
  geom_segment(aes(y = 0, 
                   x = topic, 
                   yend = ifelse(period == "Cold War", year_share*100 + 1.5, year_share*100 - 1.5), 
                   xend = topic, 
                   color = period,
                   alpha = alpha),
               size = 1.5) +
  labs(title="Share of foreign policy topics per period", 
       subtitle="Cold War vs Post-Cold War") + 
  xlab("topic") + 
  ylab("% share of topic") + 
  scale_y_continuous(limits = c(-40, 40), breaks = c(-40, -20, 0, 20, 40), labels = abs) + 
  scale_color_manual(values = c("#ba0000", "#234075")) + 
  scale_alpha_manual(values = c(0.5, 1)) + 
  guides(alpha = "none") + 
  charts.theme +
  coord_flip()
plot1
```
```{r}
plot2_df <- share_period_country %>% 
 group_by(period, country) %>% 
 mutate(alpha = ifelse(max(year_share) == year_share, "yes", "no"),
        year_share = ifelse(period == "Cold War", -1*year_share, year_share))

plot2 <-  ggplot(plot2_df, aes(x=fct_rev(topic), y=year_share*100, label=period)) + 
  geom_hline(yintercept = 0, size = 0.4, linetype = 2) +
  geom_point(stat='identity', fill="black", size=6, aes(color = period, alpha = alpha))  +
  geom_segment(aes(y = 0, 
                   x = topic, 
                   yend = ifelse(period == "Cold War", year_share*100 + 3.2, year_share*100 - 3.2), 
                   xend = topic, 
                   color = period,
                   alpha = alpha),
               size = 1.5) +
  labs(title="Share of foreign policy topics per period and per country", 
       subtitle="Cold War vs Post-Cold War") + 
  xlab("topic") + 
  ylab("% share of topic") + 
  scale_y_continuous(limits = c(-50, 40), breaks = c(-40, -20, 0, 20, 40), labels = abs) + 
  scale_color_manual(values = c("#ba0000", "#234075")) + 
  scale_alpha_manual(values = c(0.5, 1)) + 
  guides(alpha = "none") + 
  charts.theme +
  coord_flip() + 
  facet_wrap(~country)
plot2
```

```{r}
# topic-word probability (words most common in each topic)
top_words <- tidy(lda, matrix = "beta") %>% 
 group_by(topic) %>% 
 slice_max(beta, n = 200) %>% 
 ungroup() %>%
 arrange(topic, -beta) %>% 
 filter(topic %in% c(3, 4))
top_words
```

```{r}
word_type <- top_words %>% 
 pivot_wider(id_cols = topic:beta, values_from = beta, names_from = topic) %>% 
 mutate(type = ifelse(!is.na(`3`) & !is.na(`4`), "common", "unique")) 
 #filter(!(!is.na(`3`) & !is.na(`4`))) 

word_type %>% 
   group_by(type) %>%
   summarise(counts = n())
```

```{r}
plot3_df <- word_type %>% 
 pivot_longer(cols = `3`:`4`, names_to = "topic")

plot3 <- ggplot(plot3_df %>% filter(value < 0.05), aes(x = type, value)) + # remove outlier
 geom_jitter(aes(color = topic, alpha = topic), size = 4) + 
 scale_color_manual(values = c("#ba0000", "#234075")) + 
 scale_alpha_manual(values = c(0.6, 0.6)) + 
 xlab("") + 
 ylab("beta") + 
 guides(alpha = "none") + 
 labs(title = "Common and Unique Words",
      subtitle = "topic 3 & topic 4", 
      caption = "Beta refers to the probability that a word appears in a particular topic") + 
 charts.theme
plot3
```

Take top 10 words for each topic
```{r}
unique_words <- top_words %>% 
 pivot_wider(id_cols = topic:beta, values_from = beta, names_from = topic) %>% 
 filter(!(!is.na(`3`) & !is.na(`4`))) %>% 
 pivot_longer(cols = `3`:`4`, names_to = "topic") %>% 
 group_by(topic) %>% 
 slice_max(value, n = 15) %>% 
 ungroup() %>%
 arrange(topic, -value)
```

```{r}
plot4_df <- unique_words %>% 
  mutate(term = reorder_within(term, value, topic),
         topic = ifelse(topic == "3", "topic 3", "topic 4"))

plot4 <-  ggplot(plot4_df, aes(value, term, fill = factor(topic))) +
  geom_col(show.legend = FALSE) +
  facet_wrap(~ topic, scales = "free") +
  scale_fill_manual(values = c("#ba0000", "#234075")) + 
  labs(title = "Top 10 words per foreign policy topic",
       subtitle = "topic 3 vs topic 4", 
       caption = "Beta refers to the probability that a word appears in a particular topic") + 
  xlab("beta") + 
  charts.theme + 
  scale_y_reordered()
plot4
```


## 2. Research question

The research question 

Describe a research question you want to explore with topic modelling. Comment on how answerable this is with the methods and data at your disposal.

## 3. Topic model development

Create a topic model using your data. Explain to a non-specialist what the topic model does. Comment on the choices you make here in terms of hyperparameter selection and model choice. How might these affect your results and the ability to answer your research question?
 
```{r}

```
 
 
 ## 4. Topic model description
 
 Describe the topic model. What topics does it contain? How are these distributed across the data?
 
 ## 5. Answering your research question
 
 Use your topic model to answer your research question by showing plots or statistical results. Discuss the implications of what you find, and any limitations inherent in your approach. Discuss how the work could be improved upon in future research.
